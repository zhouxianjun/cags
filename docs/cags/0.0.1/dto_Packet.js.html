<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>dto/Packet.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-AbstractHandler.html">AbstractHandler</a><ul class='methods'><li data-type='method'><a href="module-AbstractHandler.html#~getUser">getUser</a></li><li data-type='method'><a href="module-AbstractHandler.html#~login">login</a></li><li data-type='method'><a href="module-AbstractHandler.html#~write">write</a></li></ul></li><li><a href="module-BasicLengthDecoder.html">BasicLengthDecoder</a><ul class='methods'><li data-type='method'><a href="module-BasicLengthDecoder.html#~addCmdHandler">addCmdHandler</a></li><li data-type='method'><a href="module-BasicLengthDecoder.html#~checkAuthorized">checkAuthorized</a></li><li data-type='method'><a href="module-BasicLengthDecoder.html#~delCmdHandler">delCmdHandler</a></li><li data-type='method'><a href="module-BasicLengthDecoder.html#~handleException">handleException</a></li><li data-type='method'><a href="module-BasicLengthDecoder.html#~init">init</a></li><li data-type='method'><a href="module-BasicLengthDecoder.html#~onMsg">onMsg</a></li><li data-type='method'><a href="module-BasicLengthDecoder.html#~onReceive">onReceive</a></li><li data-type='method'><a href="module-BasicLengthDecoder.html#~useFileSystem">useFileSystem</a></li></ul></li><li><a href="module-BasicUser.html">BasicUser</a><ul class='methods'><li data-type='method'><a href="module-BasicUser.html#~isOnline">isOnline</a></li><li data-type='method'><a href="module-BasicUser.html#~offline">offline</a></li><li data-type='method'><a href="module-BasicUser.html#~online">online</a></li><li data-type='method'><a href="module-BasicUser.html#~reconnect">reconnect</a></li><li data-type='method'><a href="module-BasicUser.html#~write">write</a></li></ul></li><li><a href="module-Builder.html">Builder</a></li><li><a href="module-ClassUtil.html">ClassUtil</a><ul class='methods'><li data-type='method'><a href="module-ClassUtil.html#.getObject">getObject</a></li><li data-type='method'><a href="module-ClassUtil.html#.reload">reload</a></li><li data-type='method'><a href="module-ClassUtil.html#.watch">watch</a></li></ul></li><li><a href="module-Packet.html">Packet</a><ul class='methods'><li data-type='method'><a href="module-Packet.html#~createSuccess">createSuccess</a></li><li data-type='method'><a href="module-Packet.html#~getBuffer">getBuffer</a></li><li data-type='method'><a href="module-Packet.html#~getSize">getSize</a></li><li data-type='method'><a href="module-Packet.html#~useLog">useLog</a></li><li data-type='method'><a href="module-Packet.html#~write">write</a></li></ul></li><li><a href="module-ProtobufUtil.html">ProtobufUtil</a><ul class='methods'><li data-type='method'><a href="module-ProtobufUtil.html#.getPath">getPath</a></li><li data-type='method'><a href="module-ProtobufUtil.html#.getUpPath">getUpPath</a></li><li data-type='method'><a href="module-ProtobufUtil.html#.isMessage">isMessage</a></li><li data-type='method'><a href="module-ProtobufUtil.html#.load">load</a></li></ul></li><li><a href="module-Result.html">Result</a></li><li><a href="module-RPCClient.html">RPCClient</a><ul class='methods'><li data-type='method'><a href="module-RPCClient.html#~getService">getService</a></li><li data-type='method'><a href="module-RPCClient.html#~init">init</a></li><li data-type='method'><a href="module-RPCClient.html#~onClose">onClose</a></li><li data-type='method'><a href="module-RPCClient.html#~onConnected">onConnected</a></li><li data-type='method'><a href="module-RPCClient.html#~onError">onError</a></li><li data-type='method'><a href="module-RPCClient.html#~onTimeout">onTimeout</a></li><li data-type='method'><a href="module-RPCClient.html#~reconnect">reconnect</a></li><li data-type='method'><a href="module-RPCClient.html#~sendToServer">sendToServer</a></li></ul></li><li><a href="module-RPCServer.html">RPCServer</a><ul class='methods'><li data-type='method'><a href="module-RPCServer.html#~add">add</a></li><li data-type='method'><a href="module-RPCServer.html#~del">del</a></li><li data-type='method'><a href="module-RPCServer.html#~getClient">getClient</a></li><li data-type='method'><a href="module-RPCServer.html#~getService">getService</a></li><li data-type='method'><a href="module-RPCServer.html#~init">init</a></li><li data-type='method'><a href="module-RPCServer.html#~onError">onError</a></li><li data-type='method'><a href="module-RPCServer.html#~onReceiveMsg">onReceiveMsg</a></li><li data-type='method'><a href="module-RPCServer.html#~receiveMsg">receiveMsg</a></li><li data-type='method'><a href="module-RPCServer.html#~sendToServer">sendToServer</a></li><li data-type='method'><a href="module-RPCServer.html#~start">start</a></li><li data-type='method'><a href="module-RPCServer.html#~useFileSystem">useFileSystem</a></li><li data-type='method'><a href="module-RPCServer.html#~useLog">useLog</a></li></ul></li><li><a href="module-WorldManager.html">WorldManager</a><ul class='methods'><li data-type='method'><a href="module-WorldManager.html#.getUser">getUser</a></li><li data-type='method'><a href="module-WorldManager.html#.hasUser">hasUser</a></li><li data-type='method'><a href="module-WorldManager.html#.init">init</a></li><li data-type='method'><a href="module-WorldManager.html#.userOffline">userOffline</a></li><li data-type='method'><a href="module-WorldManager.html#.userOnline">userOnline</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="module-AbstractHandler-run.html">run</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Sex">Sex</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">dto/Packet.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
const ring = require("ring");
const ProtoBuf = require("protobufjs");
const ProtobufUtil = require('../util/ProtobufUtil');
const Result = ProtobufUtil.load('Result').build();
/**
 * @module Packet
 */
module.exports = ring.create({
    /**
     * @property {short} cmd - 指令
     */
    cmd: undefined,
    /**
     * @property {buffer} body - 内容
     */
    body: undefined,
    /**
     * @property {Date} startTime - 开始时间
     */
    startTime: undefined,
    _result: undefined,
    _resultByte: null,
    /**
     * @property {int} headSize - 头长度大小
     */
    headSize: 2,
    _logger: null,
    /**
     * 返回状态信息code、msg
     * @returns {Result}
     */
    get result(){
        if(!this._result){
            this._result = new Result();
            this._resultByte = this._result.encode();
        }
        return this._result;
    },
    /**
     * 使用日志
     * @param {*} log - 日志
     * @returns {Packet}
     */
    useLog(log){
        this._logger = log;
        return this;
    },
    /**
     * 设置状态
     * @param {Result} val - 状态对象 protobuf
     */
    set result(val){
        if(ProtobufUtil.isMessage(val)) {
            this._result = val;
            this._resultByte = val.encode();
        }else{
            console.warn('result type require protobuf Message!');
        }
    },
    /**
     * 获取当前包大小
     * @returns {number}
     */
    getSize(){
        if(!this.cmd){
            throw new Error('cmd is not null!');
        }
        let size = this.headSize + 2;// cmd + head
        size += this._resultByte.toBuffer().length;
        this.body &amp;&amp; (size += this.body.toBuffer().length);
        return size;
    },
    /**
     * 获取包ByteBuffer
     * @returns {ByteBuffer}
     */
    getBuffer(){
        let size = this.getSize();
        if(size &lt; 0){
            return null;
        }
        let buffer = new ProtoBuf.ByteBuffer(size + this.headSize, ProtoBuf.ByteBuffer.BIG_ENDIAN);
        buffer['writeInt' + 8 * this.headSize](size, 0); //length
        buffer.writeShort(this.cmd, this.headSize);
        let retLen = this._resultByte.toBuffer().length;
        buffer.writeShort(retLen, this.headSize + 2);
        if(retLen > 0){
            buffer.append(this._resultByte);
        }
        this.body &amp;&amp; buffer.append(this.body);
        return buffer;
    },
    /**
     * 发送
     * @param {Socket} socket - 通信断
     * @param {*} user - 用户标识
     * @param {Date} start - 开始时间
     */
    write(socket, user, start){
        if(socket){
            let buffer = this.getBuffer().toBuffer();
            socket.write(buffer);
            if(this._logger){
                this._logger.info('回复消息：IP:%s, PORT:%d, 对象:%s, CMD:0x%d, code:%d, msg: %s, 总大小:%d, ret:%d, body:%d, 耗时:%d毫秒',
                socket.remoteAddress, socket.remotePort, user, this.cmd, this.result.code,
                    this.result.msg, buffer.length, this._resultByte.toBuffer().length, this.body ? this.body.toBuffer().length : 0,
                start ? new Date().getTime() - start : -1);
            }
        }
    },
    /**
     * 创建一个正确状态的包
     * @param {short} cmd - 指令
     * @param {buffer} body - 内容
     * @returns {Packet}
     */
    createSuccess(cmd, body){
        this.cmd = cmd;
        this.body = body;
        return this;
    }
});</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Dec 03 2015 14:25:52 GMT+0800 (中国标准时间) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
